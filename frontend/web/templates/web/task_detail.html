{% extends 'web/base.html' %}
{% block title %}{{ task.title }}{% endblock %}

{% block content %}
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'tasks' %}">Задачи</a></li>
        <li class="breadcrumb-item active">{{ task.title }}</li>
    </ol>
</nav>

<div class="row g-4">
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-body">
                <h3 class="fw-bold">{{ task.title }}</h3>
                <div class="d-flex gap-2 mb-3">
                    <span class="badge badge-{{ task.priority }} fs-7">{{ task.priority }}</span>
                    <span class="badge badge-{{ task.status }} fs-7">{{ task.status }}</span>
                </div>
                {% if task.description %}
                <div class="border-top pt-3">
                    <h6>Описание</h6>
                    <p>{{ task.description }}</p>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="card">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-chat-dots me-2"></i>Комментарии</h5>
            </div>
            <div class="card-body">
                {% if task.comments %}
                    {% for comment in task.comments %}
                    <div class="border-bottom pb-3 mb-3">
                        <div class="d-flex justify-content-between">
                            <strong>Пользователь #{{ comment.author_id }}</strong>
                            <small class="text-muted">{{ comment.created_at|truncatechars:16 }}</small>
                        </div>
                        <p class="mb-0 mt-1">{{ comment.text }}</p>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted text-center">Комментариев пока нет</p>
                {% endif %}

                <form method="post" class="mt-3">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="add_comment">
                    <div class="mb-2">
                        <textarea class="form-control" name="text" rows="2" placeholder="Напишите комментарий..." required></textarea>
                    </div>
                    <button type="submit" class="btn btn-sm btn-primary">
                        <i class="bi bi-send me-1"></i> Отправить
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header bg-white">
                <h6 class="mb-0">Информация</h6>
            </div>
            <div class="card-body">
                <dl class="mb-0">
                    <dt>Проект</dt>
                    <dd><a href="{% url 'project-detail' task.project %}">Проект #{{ task.project }}</a></dd>
                    <dt>Автор</dt>
                    <dd>Пользователь #{{ task.creator_id }}</dd>
                    <dt>Исполнитель</dt>
                    <dd>{% if task.assignee_id %}Пользователь #{{ task.assignee_id }}{% else %}Не назначен{% endif %}</dd>
                    {% if task.deadline %}
                    <dt>Крайний срок</dt>
                    <dd>{{ task.deadline|truncatechars:16 }}</dd>
                    {% endif %}
                    <dt>Создана</dt>
                    <dd>{{ task.created_at|truncatechars:16 }}</dd>
                    <dt>Обновлена</dt>
                    <dd>{{ task.updated_at|truncatechars:16 }}</dd>
                </dl>
            </div>
        </div>

        <div class="card">
            <div class="card-header bg-white">
                <h6 class="mb-0">Изменить статус</h6>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="update_status">
                    <select name="status" class="form-select mb-2">
                        <option value="todo" {% if task.status == 'todo' %}selected{% endif %}>К выполнению</option>
                        <option value="in_progress" {% if task.status == 'in_progress' %}selected{% endif %}>В работе</option>
                        <option value="review" {% if task.status == 'review' %}selected{% endif %}>На проверке</option>
                        <option value="done" {% if task.status == 'done' %}selected{% endif %}>Выполнена</option>
                        <option value="cancelled" {% if task.status == 'cancelled' %}selected{% endif %}>Отменена</option>
                    </select>
                    <button type="submit" class="btn btn-primary btn-sm w-100">Обновить</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
